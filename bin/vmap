#!/usr/bin/env ruby

$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), '..', 'lib'))

require 'io/console'

require 'icfpc2012'

begin
  require "Win32API"

  def read_char
    # little hack to capture arrow keys
    c = Win32API.new("crtdll", "_getch", [], "L").Call.chr
    if c == "\xE0"
      c = Win32API.new("crtdll", "_getch", [], "L").Call.chr
      case c
      when "H"
        return "U"
      when "P"
        return "D"
      when "K"
        return "L"
      when "M"
        return "R"
      else
        c
      end
    end
    c
  end
rescue LoadError
  def read_char
    system "stty raw -echo"
    STDIN.getc
  ensure
    system "stty -raw echo"
  end
end

def is_valid_input(i)
  i == 'U' || i == 'D' || i == 'L' || i == 'R' || i == 'W' ? true : false
end

def read_map
  input_map = './maps/contest1.map.txt'
  if ARGF.argv != []
    input_map = ARGF.argv[0]
  end

  Icfpc2012::Map.new(File.read(input_map))
end

def print_map(map)
  map.to_s.each_line { |line| puts line }
  puts "score: " + map.score.to_s
  puts "path: " + map.path.to_s
end

begin
  map = read_map
  loop do
    print_map(map)

    begin
      step = read_char.capitalize
      raise Interrupt if step.chr == "A" || step.chr == "\e"
      if step.chr == "Z"
        map = map.step_back
        print_map(map)
      end
    end until is_valid_input(step)

    map = map.step(step)
    puts step

  end
rescue Interrupt
  puts 'Quitting...'
  exit 1
end
